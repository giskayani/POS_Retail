<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Smart Retail POS - Dashboard</title>
  <script src="https://cdn.webix.com/edge/webix.js"></script>
  <link rel="stylesheet" href="https://cdn.webix.com/edge/webix.css">
  <script src="assets/js/auth.js"></script> 
  <style>
    html, body {
      height: 100%; 
      margin: 0;
      padding: 0;
      overflow: hidden; 
    }
  </style>
</head>
<body>
  <script>
    webix.ready(function() {
      ensureAuthenticated();
      const user = getCurrentUser();
      
      if (user.role !== "admin") {
        window.location.href = "/pos.html";
        return;
      }

      webix.ui({
        rows: [
          {
            view: "toolbar",
            elements: [
              { view: "label", label: "Smart Retail POS - Admin Dashboard" },
              {},
              { view: "label", label: `Welcome, ${user.username}` },
              { view: "button", value: "Change Password", width: 140, click: showChangePasswordForm },
              { view: "button", value: "Logout", width: 80, click: logout }
            ]
          },
          {
            cols: [
              {
                view: "sidebar",
                width: 200,
                data: [
                  { id: "dashboard", value: "Dashboard", icon: "wxi-columns" },
                  { id: "products", value: "Products", icon: "wxi-package" },
                  { id: "sales", value: "Sales", icon: "wxi-chart" },
                  { id: "analytics", value: "Analytics", icon: "wxi-line-chart" },
                  { id: "users", value: "User Management", icon: "wxi-user"}
                ],
                on: {
                  onAfterSelect: function(id) {
                    showContent(id);
                  }
                }
              },
              {
                id: "content",
                rows: [
                  getDashboardContent()
                ]
              }
            ]
          }
        ]
      });

      loadDashboardStats();
    });

    function getDashboardContent() {
      return {
        rows: [
          {
            cols: [
              {
                view: "template",
                template: "<div style='text-align:center; padding:20px;'><h3>Today's Sales</h3><h2 id='todaySales'>$0</h2></div>",
                css: "webix_primary"
              },
              {
                view: "template", 
                template: "<div style='text-align:center; padding:20px;'><h3>Transactions</h3><h2 id='todayTransactions'>0</h2></div>",
                css: "webix_secondary"
              },
              {
                view: "template",
                template: "<div style='text-align:center; padding:20px;'><h3>Products</h3><h2 id='totalProducts'>0</h2></div>",
                css: "webix_success"
              },
              {
                view: "template",
                template: "<div style='text-align:center; padding:20px;'><h3>Low Stock</h3><h2 id='lowStock'>0</h2></div>",
                css: "webix_danger"
              }
            ],
            height: 120
          },
          {
            cols: [
              {
                view: "chart",
                id: "dailyChart",
                type: "line",
                value: "#total_sales#",
                xAxis: { template: "#date#" },
                yAxis: {},
                legend: { values: [{ text: "Sales", color: "#36abee" }] }
              },
              {
                view: "chart",
                id: "bestSellersChart", 
                type: "bar",
                value: "#total_quantity#",
                xAxis: { template: "#product_name#" },
                yAxis: {},
                legend: { values: [{ text: "Quantity Sold", color: "#ee9336" }] }
              }
            ]
          }
        ]
      };
    }

    function getProductsContent() {
      return {
        rows: [
          {
            view: "toolbar",
            elements: [
              { view: "label", label: "Product Management" },
              {},
              { view: "button", value: "Add Product", css: "webix_primary", click: showAddProductForm }
            ]
          },
          {
            view: "datatable",
            id: "productsTable",
            columns: [
              { id: "name", header: "Name", fillspace: true, sort: "string" },
              { id: "category", header: "Category", width: 150 },
              { id: "price", header: "Price", width: 100, format: webix.i18n.priceFormat },
              { id: "stock", header: "Stock", width: 80 },
              { id: "sku", header: "SKU", width: 120 },
              { id: "actions", header: "Actions", width: 150, template: "<button class='webix_button' onclick='editProduct(\"#product_id#\")'>Edit</button> <button class='webix_button webix_danger' onclick='deleteProduct(\"#product_id#\")'>Delete</button>" }
            ],
            autoheight: true,
            select: true
          }
        ]
      };
    }

    function getUsersContent() {
      return {
        rows: [
          {
            view: "toolbar",
            elements: [
              { view: "label", label: "User Management" },
              {},
              { view: "button", value: "Add User", css: "webix_primary", click: showAddUserForm } // <-- Mirip showAddProductForm
            ]
          },
          {
            view: "datatable",
            id: "usersTable", 
            columns: [
              { id: "name", header: "Name", width: 200, sort: "string" },
              { id: "username", header: "Username", width: 150 },
              { id: "email", header: "Email", width: 200 },
              { id: "role", header: "Role", width: 100 },
              { id: "status", header: "Status", width: 80 },
              // { id: "actions", header: "Actions", width: 150, template: "..." } // tambahkan nanti
            ],
            autoheight: true,
            select: true
          }
        ]
      };
    }

    function showContent(id) {
      const content = $$("content");
      
      switch(id) {
        case "dashboard":
          content.removeView(content.getChildViews()[0]);
          content.addView(getDashboardContent());
          loadDashboardStats();
          break;
        case "products":
          content.removeView(content.getChildViews()[0]);
          content.addView(getProductsContent());
          loadProducts();
          break;
        case "sales":
          content.removeView(content.getChildViews()[0]);
          content.addView(getSalesContent());
          loadSales();
          break;
        case "analytics":
          content.removeView(content.getChildViews()[0]);
          content.addView(getAnalyticsContent());
          loadAnalytics();
          break;
        case "users":
          content.removeView(content.getChildViews()[0]);
          content.addView(getUsersContent()); 
          loadUsers(); 
          break;
      }
    }

    function loadDashboardStats() {
      fetch("/api/dashboard/stats", {
        headers: { "Authorization": "Bearer " + localStorage.getItem("jwt") }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("todaySales").textContent = "$" + data.today_sales.toFixed(2);
        document.getElementById("todayTransactions").textContent = data.today_transactions;
        document.getElementById("totalProducts").textContent = data.total_products;
        document.getElementById("lowStock").textContent = data.low_stock_products;
      });

      // Load charts
      loadDailyChart();
      loadBestSellersChart();
    }

    function loadDailyChart() {
      fetch("/api/sales/analytics/daily?days=7", {
        headers: { "Authorization": "Bearer " + localStorage.getItem("jwt") }
      })
      .then(res => res.json())
      .then(data => {
        const chartData = data.map(item => ({
          date: item._id,
          total_sales: item.total_sales
        }));
        $$("dailyChart").parse(chartData);
      });
    }

    function loadBestSellersChart() {
      fetch("/api/sales/analytics/bestsellers?limit=5", {
        headers: { "Authorization": "Bearer " + localStorage.getItem("jwt") }
      })
      .then(res => res.json())
      .then(data => {
        $$("bestSellersChart").parse(data);
      });
    }

    function loadProducts() {
      fetch("/api/products/", {
        headers: { "Authorization": "Bearer " + localStorage.getItem("jwt") }
      })
      .then(res => res.json())
      .then(data => {
        $$("productsTable").parse(data);
      });
    }

    function loadUsers() {
      fetch("/api/employees/list", { 
        headers: { "Authorization": "Bearer " + localStorage.getItem("jwt") }
      })
      .then(res => res.json())
      .then(data => {
        $$("usersTable").parse(data);
      });
    }

    function showAddProductForm() {
      webix.ui({
        view: "window",
        id: "productWindow",
        width: 400,
        position: "center",
        head: "Add Product",
        body: {
          view: "form",
          id: "productForm",
          elements: [
            { view: "text", name: "name", label: "Name", required: true },
            { view: "text", name: "category", label: "Category" },
            { view: "text", name: "price", label: "Price", required: true },
            { view: "text", name: "stock", label: "Stock", required: true },
            { view: "text", name: "sku", label: "SKU" },
            {
              cols: [
                { view: "button", value: "Save", css: "webix_primary", click: saveProduct },
                { view: "button", value: "Cancel", click: function() { $$("productWindow").close(); } }
              ]
            }
          ]
        }
      }).show();
    }

    function showAddUserForm() {
      webix.ui({
        view: "window",
        id: "userWindow",
        width: 400,
        position: "center",
        head: "Add User",
        body: {
          view: "form",
          id: "userForm",
          elements: [
            { view: "text", name: "nama", label: "Name", required: true },
            { view: "text", name: "username", label: "Username", required: true },
            { view: "text", name: "email", label: "Email", required: true },
            { view: "text", type:"password", name: "password", label: "Password", required: true },
            { view: "combo", label: "Role", name: "role", options: ["admin", "kasir"], value: "kasir", required: true }, // <-- INI AMAN, karena hanya Admin yang melihatnya
            {
              cols: [
                { view: "button", value: "Save", css: "webix_primary", click: saveUser },
                { view: "button", value: "Cancel", click: function() { $$("userWindow").close(); } }
              ]
            }
          ]
        }
      }).show();
    }

    function showChangePasswordForm() {
      webix.ui({
        view: "window",
        id: "changePasswordWindow",
        width: 400,
        position: "center",
        head: "Change My Password",
        body: {
          view: "form",
          id: "changePasswordForm",
          elements: [
            { view: "text", type:"password", name: "current_password", label: "Current Password", required: true },
            { view: "text", type:"password", name: "new_password", label: "New Password", required: true },
            { view: "text", type:"password", name: "confirm_password", label: "Confirm New Password", required: true },
            {
              cols: [
                { view: "button", value: "Save", css: "webix_primary", click: saveNewPassword },
                { view: "button", value: "Cancel", click: function() { $$("changePasswordWindow").close(); } }
              ]
            }
          ]
        }
      }).show();
    }

    function saveProduct() {
      const form = $$("productForm");
      if (!form.validate()) return;

      const data = form.getValues();
      
      fetch("/api/products/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + localStorage.getItem("jwt")
        },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(data => {
        if (data.errors) {
          webix.message({ type: "error", text: data.errors.join(", ") });
        } else {
          webix.message({ type: "success", text: "Product added successfully" });
          $$("productWindow").close();
          loadProducts();
        }
      });
    }

    function saveUser() {
      const form = $$("userForm");
      if (!form.validate()) return; 

      const data = form.getValues();

      fetch("/api/employee/", { 
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + localStorage.getItem("jwt")
        },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          webix.message({ type: "error", text: data.error });
        } else {
          webix.message({ type: "success", text: "User added successfully" });
          $$("userWindow").close();
          loadUsers(); // Refresh tabel
        }
      });
    }

    function saveNewPassword() {
      const form = $$("changePasswordForm");
      if (!form.validate()) return;

      const data = form.getValues();
      
      if (data.new_password !== data.confirm_password) {
        webix.message({ type: "error", text: "Password baru tidak cocok!" });
        return;
      }

      fetch("/api/change-my-password", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + localStorage.getItem("jwt")
        },
        // Hanya kirim yang dibutuhkan oleh backend
        body: JSON.stringify({
            current_password: data.current_password,
            new_password: data.new_password
        })
      })
      .then(res => res.json().then(body => ({ status: res.status, body: body })))
      .then(data => {
        if (data.status === 200) {
          webix.message({ type: "success", text: data.body.message });
          $$("changePasswordWindow").close();
        } else {
          webix.message({ type: "error", text: data.body.error || "Gagal mengubah password" });
        }
      });
    }

    function editProduct(productId) {
      // Implementation for edit product
      webix.message("Edit product: " + productId);
    }

    function deleteProduct(productId) {
      webix.confirm("Are you sure you want to delete this product?")
      .then(() => {
        fetch(`/api/products/${productId}`, {
          method: "DELETE",
          headers: { "Authorization": "Bearer " + localStorage.getItem("jwt") }
        })
        .then(res => res.json())
        .then(data => {
          webix.message({ type: "success", text: "Product deleted successfully" });
          loadProducts();
        });
      });
    }
  </script>
</body>
</html>